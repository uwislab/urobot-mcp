<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepseek AI助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2a5298',
                        secondary: '#4b7bec',
                        accent: '#3867d6',
                        neutral: '#f8fafc',
                        dark: '#1e293b',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                @apply bg-white/90 backdrop-blur-md border border-white/30 shadow-xl;
            }
            .btn-primary {
                @apply bg-gradient-to-r from-primary to-accent text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .btn-secondary {
                @apply bg-white text-primary font-semibold py-3 px-6 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen font-inter text-dark">
    <!-- 背景装饰元素 -->
    <div class="fixed inset-0 overflow-hidden -z-10">
        <div class="absolute -top-40 -right-40 w-96 h-96 bg-primary/10 rounded-full blur-3xl"></div>
        <div class="absolute top-1/3 -left-20 w-72 h-72 bg-secondary/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-40 right-1/4 w-80 h-80 bg-accent/10 rounded-full blur-3xl"></div>
    </div>

    <!-- 主容器 -->
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 头部 -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white">
                        <i class="fa-solid fa-brain text-2xl"></i>
                    </div>
                    <h1 class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent">
                        Deepseek AI
                    </h1>
                </div>
                <nav>
                    <button id="showHistoryButton" class="btn-secondary flex items-center gap-2">
                        <i class="fa-solid fa-history"></i>
                        <span class="hidden sm:inline">历史记录</span>
                    </button>
                </nav>
            </div>
            <p class="text-slate-600 mt-2">
                强大的AI助手，帮你生成高质量的C代码和PlantUML图表
            </p>
        </header>

        <!-- 功能按钮组 -->
        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <button id="runScript3Button" class="btn-primary flex flex-col items-center justify-center gap-2">
                <i class="fa-solid fa-code text-xl"></i>
                <span>生成C代码</span>
            </button>
            <button id="runScript4Button" class="btn-primary flex flex-col items-center justify-center gap-2">
                <i class="fa-solid fa-diagram-project text-xl"></i>
                <span>生成PlantUML</span>
            </button>
            <button onclick="window.location.href='/';" class="btn-secondary flex flex-col items-center justify-center gap-2">
                <i class="fa-solid fa-arrow-left text-xl"></i>
                <span>返回首页</span>
            </button>
            <button id="voiceInputButton" class="btn-primary flex items-center justify-center gap-2">
                <i class="fa-solid fa-microphone text-xl"></i>
                <span class="hidden sm:inline">语音输入</span>
            </button>
        </div>

        <!-- 输入区域 -->
        <div class="mb-6">
            <textarea id="promptInput" class="w-full p-4 rounded-xl border border-slate-200 focus:border-primary focus:ring-2 focus:ring-primary/20 resize-none transition-all duration-300 h-24" placeholder="请输入你的需求描述..."></textarea>
        </div>

        <!-- 结果显示区域 -->
        <div class="mb-8">
            <div class="glass-effect rounded-xl overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="font-semibold text-slate-700">AI生成结果</h3>
                    <div class="flex gap-2">
                        <button id="copyButton" class="text-slate-600 hover:text-primary transition-colors duration-300">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                        <button id="clearButton" class="text-slate-600 hover:text-red-500 transition-colors duration-300">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4 h-[clamp(300px,50vh,500px)] relative">
                    <div class="loader absolute inset-0 flex items-center justify-center bg-white/80 rounded-lg z-10 hidden">
                        <div class="w-12 h-12 border-4 border-slate-200 border-t-primary rounded-full animate-spin"></div>
                        <p class="ml-4 text-slate-600">思考中...</p>
                    </div>
                    <pre id="result" class="h-full overflow-y-auto text-slate-800 text-sm sm:text-base leading-relaxed"></pre>
                </div>
            </div>
        </div>

        <!-- 历史记录面板 -->
        <div id="historyPanel" class="mb-8 hidden">
            <div class="glass-effect rounded-xl overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="font-semibold text-slate-700">历史记录</h3>
                    <button id="closeHistoryButton" class="text-slate-600 hover:text-red-500 transition-colors duration-300">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="p-4 max-h-[400px] overflow-y-auto">
                    <div id="historyList" class="space-y-3">
                        <!-- 历史记录将通过JS动态填充 -->
                        <div class="text-center text-slate-500 py-8">暂无历史记录</div>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t border-slate-200">
                    <button id="clearHistoryButton" class="btn-secondary text-sm py-2 px-4">
                        <i class="fa-solid fa-trash mr-2"></i>清空历史
                    </button>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-500 flex items-center gap-2 z-50">
        <i class="fa-solid fa-check-circle"></i>
        <span id="notificationText">操作成功</span>
    </div>

    <script>
        // 历史记录功能
        const HISTORY_KEY = 'deepseekHistory';

        // 加载历史记录
        function loadHistory() {
            const historyList = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');

            if (history.length === 0) {
                historyList.innerHTML = '<div class="text-center text-slate-500 py-8">暂无历史记录</div>';
                return;
            }

            historyList.innerHTML = history.map((item, index) => `
                <div class="bg-white rounded-lg shadow-sm p-4 transition-all duration-300 hover:shadow-md">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-slate-800">${item.endpoint === '/run_script3' ? '生成C代码' : '生成PlantUML'}</h4>
                        <span class="text-xs text-slate-500">${new Date(item.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="text-sm text-slate-600 mb-2 line-clamp-2">
                        <strong>输入:</strong> ${item.prompt || '无输入'}
                    </div>
                    <div class="text-sm text-slate-700 mb-3 line-clamp-3">
                        <strong>结果:</strong> ${item.result.substring(0, 150)}${item.result.length > 150 ? '...' : ''}
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="showHistoryDetail(${index})" class="text-xs text-primary hover:text-accent transition-colors">
                            <i class="fa-solid fa-eye mr-1"></i>查看详情
                        </button>
                        <button onclick="deleteHistoryItem(${index})" class="text-xs text-red-500 hover:text-red-600 transition-colors">
                            <i class="fa-solid fa-trash mr-1"></i>删除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 显示历史详情
        function showHistoryDetail(index) {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const item = history[index];
            if (item) {
                document.getElementById('result').innerText = `[${new Date(item.timestamp).toLocaleString()}]\n请求: ${item.endpoint === '/run_script3' ? '生成C代码' : '生成PlantUML'}\n输入: ${item.prompt || '无输入'}\n\n结果:\n${item.result}`;
                document.getElementById('historyPanel').classList.add('hidden');
            }
        }

        // 添加历史记录
        function addHistory(endpoint, prompt, result) {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            history.unshift({
                timestamp: new Date().toISOString(),
                endpoint,
                prompt,
                result
            });
            // 只保留最近10条记录
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
            loadHistory();
        }

        // 删除单条历史记录
        function deleteHistoryItem(index) {
            if (confirm('确定要删除这条历史记录吗？')) {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                history.splice(index, 1);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                loadHistory();
            }
        }

        // 切换历史记录面板显示
        document.getElementById('showHistoryButton').addEventListener('click', () => {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                loadHistory();
            }
        });

        document.getElementById('closeHistoryButton').addEventListener('click', () => {
            document.getElementById('historyPanel').classList.add('hidden');
        });

        // 清除历史记录
        document.getElementById('clearHistoryButton').addEventListener('click', () => {
            if (confirm('确定要清空所有历史记录吗？')) {
                localStorage.removeItem(HISTORY_KEY);
                loadHistory();
            }
        });

        // 获取DOM元素
        const runScript3Button = document.getElementById('runScript3Button');
        const runScript4Button = document.getElementById('runScript4Button');
        const resultText = document.getElementById('result');
        const promptInput = document.getElementById('promptInput');
        const copyButton = document.getElementById('copyButton');
        const clearButton = document.getElementById('clearButton');

        // 运行脚本的通用函数
        async function runScript(endpoint) {
            try {
                // 显示加载动画
                const loader = document.querySelector('.loader');
                loader.classList.remove('hidden');
                resultText.innerText = '';  // 清空结果

                // 获取用户输入
                const userPrompt = promptInput.value.trim() || '请生成相关代码';

                // 禁用按钮
                runScript3Button.disabled = true;
                runScript4Button.disabled = true;

                // 发送POST请求
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: userPrompt
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP错误，状态码: ${response.status}`);
                }

                const data = await response.json();  // 解析响应

                // 处理响应数据
                let output = "";

                // 检查不同可能的返回字段
                if (data.result) {
                    output = data.result;
                } else if (data.message) {
                    output = data.message;
                } else if (data.error) {
                    output = "错误: " + data.error;
                } else if (data.choices && data.choices[0] && data.choices[0].message) {
                    // 处理Deepseek API的直接响应
                    output = data.choices[0].message.content;
                } else {
                    output = "原始响应数据:\n" + JSON.stringify(data, null, 2);
                }

                // 隐藏加载动画
                loader.classList.add('hidden');

                // 显示结果
                resultText.innerText = output;

                // 保存到历史记录
                addHistory(endpoint, userPrompt, output);

                // 启用按钮
                runScript3Button.disabled = false;
                runScript4Button.disabled = false;

            } catch (error) {
                // 处理异常
                console.error("请求出错:", error);
                const loader = document.querySelector('.loader');
                loader.classList.add('hidden');

                let errorMsg = `请求出错: ${error.message}\n`;
                resultText.innerText = errorMsg;

                // 启用按钮
                runScript3Button.disabled = false;
                runScript4Button.disabled = false;
            }
        }

        // 绑定按钮事件
        runScript3Button.addEventListener('click', () => runScript('/run_script3'));
        runScript4Button.addEventListener('click', () => runScript('/run_script4'));

        // 复制到剪贴板
        copyButton.addEventListener('click', () => {
            const text = resultText.innerText;
            navigator.clipboard.writeText(text).then(() => {
                console.log('复制成功');
            }).catch(err => {
                console.error('复制失败:', err);
            });
        });

        // 清空结果
        clearButton.addEventListener('click', () => {
            resultText.innerText = '';
        });

        // 语音识别功能
        const voiceInputButton = document.getElementById('voiceInputButton');
        let recognition = null;
        let isListening = false;

        // 检查浏览器是否支持语音识别
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';

            recognition.onresult = (event) => {
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }

                // 追加到输入框
                if (finalTranscript) {
                    promptInput.value += finalTranscript;
                }
            };

            recognition.onerror = (event) => {
                console.error('语音识别错误:', event.error);
                voiceInputButton.classList.remove('bg-accent');
                voiceInputButton.classList.add('bg-red-500');
                setTimeout(() => {
                    voiceInputButton.classList.remove('bg-red-500');
                    voiceInputButton.classList.add(isListening ? 'bg-accent' : 'bg-primary');
                }, 1000);
            };

            recognition.onend = () => {
                if (isListening) {
                    recognition.start(); // 自动重新开始
                }
            };

            voiceInputButton.addEventListener('click', () => {
                isListening = !isListening;

                if (isListening) {
                    recognition.start();
                    voiceInputButton.classList.remove('bg-primary');
                    voiceInputButton.classList.add('bg-accent');
                } else {
                    recognition.stop();
                    voiceInputButton.classList.remove('bg-accent');
                    voiceInputButton.classList.add('bg-primary');
                }
            });
        } else {
            voiceInputButton.disabled = true;
            voiceInputButton.classList.add('opacity-50', 'cursor-not-allowed');
            voiceInputButton.title = '您的浏览器不支持语音识别功能';
        }

        // 初始化页面时加载历史记录
        loadHistory();
    </script>
</body>
</html>